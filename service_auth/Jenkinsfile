pipeline {
    agent any

    environment {
        APP_NAME = 'service-auth'
    }

    tools {
        // Assurez-vous que ce nom correspond à votre config (ex: 'Maven-3.9' ou 'M3')
        maven 'Maven-3.9'
    }

    stages {
        stage('Checkout') {
            steps {
                // Récupère le code depuis GitHub
                checkout scm
            }
        }

        stage('Clean & Compile') {
            steps {
                // On nettoie et on compile sans lancer les tests pour l'instant
                sh 'mvn clean compile'
            }
        }

        stage('Run Tests') {
            steps {
                // Le flag -U force la mise à jour des dépendances
                // Le flag -e affiche plus de détails en cas d'erreur
                sh 'mvn test -U -e'
            }
        }

        stage('Package JAR') {
            steps {
                // On génère le fichier .jar final dans le dossier target/
                sh 'mvn package -DskipTests'

                // Optionnel : Archive le JAR dans Jenkins pour pouvoir le télécharger
                archiveArtifacts artifacts: '**/target/*.jar', fingerprint: true
            }
        }
    }

    post {
        always {
            // Nettoyage de l'espace de travail (optionnel)
            echo 'Fin de l\'exécution du pipeline.'
        }
        success {
            echo 'Félicitations ! Le build et les tests sont passés.'
        }
        failure {
            echo 'Le build a échoué. Vérifiez les logs Maven ci-dessus.'
        }
    }
}